# リアルタイムチャット機能

このセクションでは、リアルタイムチャット機能のエンドポイントについて説明します。

## 動作する上での前提条件

1. usernameが設定されている2名以上のログイン済みのユーザーを作成する

2. 1における2名以上のユーザーが参加しているチャットルームを作成してchat_idをひかえる

3. wscatなどのwebsocketコマンドを利用し、ヘッダーにアクセストークン・uriのサブディレクトリにchat_idを設定してリクエストする

## 内部挙動

チャットルーム入室時に、動作に必要な必要なリポジトリとAWSクライアントを設定します。WebSocket接続を処理し、以下のステップを実行します。

1. **チャット参加者の検証**: ユーザーがチャットに参加しているかどうかを確認します。参加していない場合は、WebSocket接続を閉じます。
2. **ユーザー情報の取得**: ユーザーの情報を取得します。
3. **チャット参加者の取得**: チャットに参加している全ユーザーの情報を取得します。
4. **セッション情報の取得**: ユーザーのセッション情報を取得します。
5. **AWSクライアントの初期化**: SESとSNSクライアントを初期化します。
6. **WebSocketクライアントの登録**: 現在のユーザーのWebSocket接続をクライアントリストに登録します。

## メッセージの受信と処理

WebSocket接続が確立された後、サーバーはクライアントからのメッセージをリアルタイムで受信し、以下の処理を行います。

1. **メッセージの受信**: クライアントからのメッセージを受信します。
2. **既読処理**: WebSocket接続中のユーザーに対しては、メッセージを既読として扱います。
3. **メッセージの作成**: 受信したメッセージをデータベースに保存し、レスポンスを生成します。
4. **通知の送信**: メールやプッシュ通知を通じて、チャット参加者に通知を送信します。
5. **メッセージのブロードキャスト**: 同じチャットルーム内の他のクライアントにメッセージをブロードキャストします。

## 例外処理

何らかの例外が発生した場合、WebSocket接続をクライアントリストから削除します。

この機能により、ユーザーはリアルタイムでメッセージを交換でき、サーバーはそれらのメッセージを適切に処理し、他の参加者に通知することができます。
